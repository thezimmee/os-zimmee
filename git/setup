#!/usr/bin/env bash
# set up git and ssh
#
# TO RUN:
# . git/setup

local GIT_EMAIL
local GIT_USERNAME
local GIT_CREDENTIAL

read -p "[?] What is your git email address (for commit messages)? " GIT_EMAIL
read -p "[?] What is your git user name (for commit messages)? " GIT_USERNAME
read -p "[?] What is your git credentials? " GIT_CREDENTIAL

## Set up SSH key.
setup_ssh () {
	ssh-keygen -t rsa -b 4096 -C "${GIT_EMAIL}"
	eval "$(ssh-agent -s)"
	ssh-add ~/.ssh/id_rsa
	pbcopy < ~/.ssh/id_rsa.pub
}


# Create new SSH key.
echo "Creating SSH key... "
if [[ -e $HOME/.ssh/id_rsa ]]; then
	read -p "An SSH key already exists. Overwrite it with a new one? "
	if [[ $REPLY =~ ^(yes|y)$ ]]; then
		rm -rf ~/.ssh
		setup_ssh
	fi
else
	setup_ssh
fi


# Set up gitconfig.
echo "Setting up .gitconfig..."

ln -s ${OSZ_ROOT}/git/gitignore.link ~/.gitignore-global
ln -s ${OSZ_ROOT}/git/gitconfig.link ~/.gitconfig

if [[ -z $GIT_USERNAME ]] || [[ -z $GIT_EMAIL ]]; then
	echo "(user choice) .gitconfig was skipped. No user name or email."
	return 1
else
	cat ${OSZ_ROOT}/git/gitconfig.local | sed -e "s/AUTHORNAME/$GIT_USERNAME/g" -e "s/AUTHOREMAIL/$GIT_EMAIL/g" -e "s/GIT_CREDENTIAL_HELPER/$GIT_CREDENTIAL/g" > "$HOME/.gitconfig.local"
fi


## WRAP IT UP.
echo "[ok] git setup DONE."
echo "[!!] Make sure to add your SSH key to github by copying \`~/.ssh/id_rsa.pub\` into your GitHub account (https://github.com/account/ssh)."
