#!/usr/bin/env bash
# Installs and configures OS Zimmee.


OSZ_REPO=git@github.com:thezimmee/os-zimmee.git
OSZ_ROOT=${OSZ_ROOT:-~/Projects/os-zimmee}
error_msg=""

install () {
	# Intro.
	echo '--- OS ZIMMEE INSTALL WIZARD ---'
	echo "[i] This wizard installs OS Zimmee."

	# OS Zimmee path.
	read -p "[?] Where should OS Zimmee be installed? " reply
	OSZ_ROOT=${reply:-$OSZ_ROOT}
	read -p "[?] Installing to ${OSZ_ROOT}. Is this correct? (Y/n) " continue
	continue=${continue:-y}
	if [[ $continue =~ ^([nN][oO]|[nN])$ ]]; then
		echo '[!] Please run installer again to start over.'
		exit 1
	fi

	# If $OSZ_ROOT doesn't exist locally, clone it.
	setup_repo || error_msg="[!] Uh oh... something went wrong cloning the OS Zimmee repo." && exit 1

	# Install apps.
	install_apps
	install_report
}

setup_repo () {
	continue=y
	if [ -d ${OSZ_ROOT} ]; then
		read -p "[?] Path to ${OSZ_ROOT} already exists. Overwrite it? (Y/n) " overwrite
		overwrite=${overwrite:-y}
	fi
	if [[ $overwrite == y ]]; then
		rm -rf $OSZ_ROOT
	else
		continue=n
	fi
	if [[ $continue == y ]]; then
		# Install git if it doesn't exist.
		if [[ -x "$(command -v git)" ]]; then
			echo "[!] Git not found. Installing homebrew and git..."
			curl -s https://raw.githubusercontent.com/thezimmee/os-zimmee/master/homebrew/install | bash
			curl -s https://raw.githubusercontent.com/thezimmee/os-zimmee/master/homebrew/install | bash
		fi
		# Clone the repo...
		echo "Cloning ${OSZ_REPO} to ${OSZ_ROOT}..."
		git clone --recursive "$OSZ_REPO" "$OSZ_ROOT"
	fi
}

# Install apps.
install_apps () {
	apps=(homebrew node)
	echo "[i] Installing prerequisites..."
	for app in ${apps[@]}; do
		if [[ ! -d "${OSZ_ROOT}/${app}" || ! -f "${OSZ_ROOT}/${app}/install" ]]; then
			echo "[i] Skipping ${app}. It is either not a directory or does not contain an install script."
		fi
		source ${OSZ_ROOT}/${app}/install || error_msg+="[!] ${app} install failed. :(\n"
	done

	echo "[i] Installing apps..."
	for dir in ${OSZ_ROOT}/*; do
		if [[ -d "$dir" && ${dir} != homebrew && ${dir} != node && -f "$dir/install" ]]; then
			read -p "[?] Do you want to install ${dir}? (Y/n) " continue
			continue=${continue:-y}
			if [[ $continue =~ ^([yY][eE][sS]|[yY])$ ]]; then
				source ${OSZ_ROOT}/${dir}/install || error_msg+="[!] ${dir} install failed. :(\n"
			fi
		fi
	done
}

# Run post install report.
install_report () {
	# wrap up
	if [[ "$error_msg" != "" ]]; then
		echo "[!] Uh oh, there was a problem..."
		echo -e "${error_msg}"
		echo "---"
		echo "Either try again or manually install missing pieces listed."
	else
		echo -e "[SUCCESS]------------------------------"
		echo -e "Woot woot! OS Zimmee setup is complete!"
		echo -e "To install apps, run \`$OSZ_ROOT/<app directory>/install\`."
		echo -e "Enjoy!!! :)"
	fi
	echo ''
}

# install & update
install
