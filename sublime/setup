#!/bin/bash
# install sublime
#
# `bash sublime/setup`

# Load config.
if [[ -z $CONFIG__loaded ]]; then
	local script_path=${BASH_SOURCE[0]:-${(%):-%N}}
	CURRENT=${PWD} && cd -P "$(dirname $script_path)" && . ../config && cd $CURRENT
fi

install_package_control () {
	curl http://sublime.wbond.net/Package%20Control.sublime-package -o "$CONFIG__package_control_file"
}

setup_sublime () {
	echo "Setting up Sublime..."
	# Symlink sublime user preferences.
	if [ -e "${CONFIG__packages_path}/Packages" ]; then
		read -p "Sublime /Packages directory already exists... overwrite with symlink? [y(es)/n(o)] "
		if [[ $REPLY =~ ^(yes|y)$ ]]; then
			rm -r "${CONFIG__packages_path}/Packages"
		fi
	fi
	mkdir -p "${CONFIG__packages_path}"
	ln -sf "$OSZ_ROOT/sublime/Packages" "${CONFIG__packages_path}/Packages"

	# Symlink all .link files to the home directory.
	read -p "Symlink all sublime/*.link files and folders to the home directory? [y(es)/n(o)] "
	if [[ $REPLY =~ ^(yes|y)$ ]]; then
		setup_dotfiles
	fi

	# Set as default text editor.
	read -p "Set Sublime as default text editor? [y(es)/n(o)] "
	if [[ $REPLY =~ ^(yes|y)$ ]]; then
		defaults write com.apple.LaunchServices LSHandlers -array-add '{LSHandlerContentType=public.plain-text;LSHandlerRoleAll=com.sublimetext.3;}'
	fi

	# Done.
	echo "Sublime setup complete!"
	echo "Sublime should automatically install packages after you install package control from the command palette. If the packages do not automatically install, do the following:"
	echo "  1) After package control is installed, open ~/Projects/os-zimmee/sublime/Packages/User/Package\ Control.sublime-settings."
	echo "  2) Create a comma-delimited list from the \`installed_packages\` property."
	echo "  3) Type \`advanced install\` in the command prompt and paste the comma-delimited list of packages."
}

setup_dotfiles () {
	for dotfile in $(find ${OSZ_ROOT}/sublime -name '*.link'); do
		dest="$HOME/.$(basename "${dotfile%.*}")"
		if [[ $(readlink "$dest") != "$dotfile" ]]; then
			ln -sf "$dotfile" "$dest"
		fi
	done
	echo "Sublime dotfiles setup complete."
}

read -p "What do you want to set up for Sublime? (1) Dotfiles; (2) Everything; "
if [[ $REPLY = 1 ]]; then
	setup_dotfiles
else
	setup_sublime
fi
